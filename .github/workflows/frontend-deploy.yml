name: Frontend Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3️⃣ Install dependencies & build
      - name: Install Dependencies and Build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          cd frontend
          npm ci
          npm run build

      # 4️⃣ Set SSH credentials
      - name: Set SSH credentials
        id: ssh-creds
        run: |
          # LIGHTSAIL_HOST_F contains only the IP address
          SSH_HOST="${{ secrets.LIGHTSAIL_HOST_F }}"
          SSH_USERNAME="ubuntu"
          echo "username=$SSH_USERNAME" >> $GITHUB_OUTPUT
          echo "host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "✅ Using username: $SSH_USERNAME"
          echo "✅ Using host: $SSH_HOST"

      # 5️⃣ Prepare temp directory on Lightsail
      - name: Prepare Lightsail temp directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.ssh-creds.outputs.host }}
          username: ${{ steps.ssh-creds.outputs.username }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30s
          script: |
            rm -rf ~/deploy-temp
            mkdir -p ~/deploy-temp
            chmod 775 ~/deploy-temp
            echo "✅ Temp directory prepared"

      # 6️⃣ Upload build using rsync
      - name: Upload build to Lightsail
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: frontend/dist/
          remote_path: ~/deploy-temp/
          remote_host: ${{ steps.ssh-creds.outputs.host }}
          remote_user: ${{ steps.ssh-creds.outputs.username }}
          remote_key: ${{ secrets.LIGHTSAIL_SSH_KEY }}

      # 7️⃣ Deploy to Nginx web root
      - name: Deploy to Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.ssh-creds.outputs.host }}
          username: ${{ steps.ssh-creds.outputs.username }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30s
          script: |
            sudo rm -rf /var/www/html/*
            sudo mkdir -p /var/www/html
            sudo cp -R ~/deploy-temp/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
            rm -rf ~/deploy-temp

            sudo rm -rf /var/cache/nginx/*
            sudo systemctl restart nginx

            echo "✅ Frontend deployment completed!"

      # 8️⃣ Verify Deployment
      - name: Verify Deployment
        run: |
          sleep 3
          SSH_HOST="${{ steps.ssh-creds.outputs.host }}"
          curl -f --max-time 10 http://${SSH_HOST} || echo "Frontend deployment completed. Verify manually if needed."
