name: Frontend Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3Ô∏è‚É£ Install dependencies & builds
      - name: Install Dependencies and Build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          cd frontend
          npm ci
          npm run build

      # 4Ô∏è‚É£ Setup SSH (same as backend)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIGHTSAIL_SSH_KEY }}

      # 5Ô∏è‚É£ Add Lightsail host to known hosts
      - name: Add Lightsail host to known hosts
        run: |
          LIGHTSAIL_HOST_ONLY=$(echo ${{ secrets.LIGHTSAIL_HOST }} | sed 's/.*@//')
          ssh-keyscan -H ${LIGHTSAIL_HOST_ONLY} >> ~/.ssh/known_hosts

      # 6Ô∏è‚É£ Test SSH Connection
      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.LIGHTSAIL_HOST }} "echo 'SSH connection successful'"

      # 7Ô∏è‚É£ Prepare temp directory and upload build
      - name: Prepare temp directory on Lightsail
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.LIGHTSAIL_HOST }} "rm -rf ~/deploy-temp && mkdir -p ~/deploy-temp && chmod 775 ~/deploy-temp"
          echo "‚úÖ Temp directory prepared"

      # 8Ô∏è‚É£ Upload build using rsync
      - name: Upload build to Lightsail
        run: |
          LIGHTSAIL_HOST_ONLY=$(echo ${{ secrets.LIGHTSAIL_HOST }} | sed 's/.*@//')
          rsync -avzr --delete frontend/dist/ ${{ secrets.LIGHTSAIL_HOST }}:~/deploy-temp/
          echo "‚úÖ Build uploaded"

      # 9Ô∏è‚É£ Deploy to Nginx web root
      - name: Deploy to Nginx
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.LIGHTSAIL_HOST }} << 'ENDSSH'
            sudo rm -rf /var/www/html/*
            sudo mkdir -p /var/www/html
            sudo cp -R ~/deploy-temp/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
            rm -rf ~/deploy-temp

            sudo rm -rf /var/cache/nginx/*
            sudo systemctl restart nginx

            echo "‚úÖ Frontend deployment completed!"
          ENDSSH

      # üîü Verify Deployment
      - name: Verify Deployment
        run: |
          sleep 3
          LIGHTSAIL_HOST_ONLY=$(echo ${{ secrets.LIGHTSAIL_HOST }} | sed 's/.*@//')
          curl -f --max-time 10 http://${LIGHTSAIL_HOST_ONLY} || echo "Frontend deployment completed. Verify manually if needed."
