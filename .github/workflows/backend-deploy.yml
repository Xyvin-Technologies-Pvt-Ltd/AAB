name: Backend Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}

jobs:
  deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIGHTSAIL_SSH_KEY }}

      - name: Add Lightsail host to known hosts
        run: |
          LIGHTSAIL_HOST_ONLY=$(echo ${{ secrets.LIGHTSAIL_HOST }} | sed 's/.*@//')
          ssh-keyscan -H ${LIGHTSAIL_HOST_ONLY} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.LIGHTSAIL_HOST }} "echo 'SSH connection successful'"

      - name: Deploy to Lightsail Instance
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          # Create deployment script
          cat > deploy-backend.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          ECR_REGISTRY="$1"
          ECR_REPOSITORY="$2"
          AWS_REGION="$3"
          MONGODB_URI="$4"
          JWT_SECRET="$5"
          JWT_EXPIRE="$6"
          AWS_ACCESS_KEY_ID="$7"
          AWS_SECRET_ACCESS_KEY="$8"
          AWS_S3_BUCKET_NAME="$9"
          FRONTEND_URL="${10}"
          
          # Login to ECR
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          
          # Pull latest image
          docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
          
          # Stop and remove existing container if running
          docker stop accounting-backend || true
          docker rm accounting-backend || true
          
          # Run new container with environment variables
          docker run -d \
            --name accounting-backend \
            --restart unless-stopped \
            -p 5001:5001 \
            -e NODE_ENV=production \
            -e PORT=5001 \
            -e MONGODB_URI="${MONGODB_URI}" \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e JWT_EXPIRE="${JWT_EXPIRE}" \
            -e AWS_REGION="${AWS_REGION}" \
            -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}" \
            -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}" \
            -e AWS_S3_BUCKET_NAME="${AWS_S3_BUCKET_NAME}" \
            -e FRONTEND_URL="${FRONTEND_URL}" \
            ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
          
          # Wait for container to be healthy
          echo "Waiting for container to be healthy..."
          sleep 10
          
          # Health check
          for i in {1..30}; do
            if curl -f http://localhost:5001/health > /dev/null 2>&1; then
              echo "Container is healthy!"
              exit 0
            fi
            echo "Waiting for health check... ($i/30)"
            sleep 2
          done
          
          echo "Health check failed!"
          docker logs accounting-backend
          exit 1
          DEPLOY_SCRIPT
          
          # Upload and execute script on Lightsail instance
          chmod +x deploy-backend.sh
          scp -o StrictHostKeyChecking=no deploy-backend.sh ${{ secrets.LIGHTSAIL_HOST }}:/tmp/deploy-backend.sh
          ssh -o StrictHostKeyChecking=no ${{ secrets.LIGHTSAIL_HOST }} "bash /tmp/deploy-backend.sh \
            '${{ steps.login-ecr.outputs.registry }}' \
            '${{ env.ECR_REPOSITORY }}' \
            '${{ secrets.AWS_REGION }}' \
            '${{ secrets.MONGODB_URI }}' \
            '${{ secrets.OPENAI_API_KEY_TEST }}' \
            '${{ secrets.JWT_SECRET }}' \
            '${{ secrets.JWT_EXPIRE }}' \
            '${{ secrets.AWS_ACCESS_KEY_ID }}' \
            '${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
            '${{ secrets.AWS_S3_BUCKET_NAME }}' \
            '${{ secrets.FRONTEND_URL }}'"
          rm deploy-backend.sh

      - name: Verify Deployment
        run: |
          sleep 5
          LIGHTSAIL_HOST_ONLY=$(echo ${{ secrets.LIGHTSAIL_HOST }} | sed 's/.*@//')
          # Verify container is running
          ssh -o StrictHostKeyChecking=no ${{ secrets.LIGHTSAIL_HOST }} "docker ps | grep accounting-backend || exit 1"
          # Verify health endpoint through nginx (if nginx is configured)
          curl -f --max-time 10 http://${LIGHTSAIL_HOST_ONLY}/health || echo "Health check via nginx failed, but container is running"

